<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="askusername">
        <input type="text" placeholder="Enter your nickname..." class="userinput"/>
        <button onclick="nameentry()">Play</button>
    </div>
    <div class="mainmenu" style="display: none;">
        <div class="navbar">
            <i class="fa-solid fa-gear" onclick="settingsopen()"></i>
            <span>
                <i class="fa-solid fa-user"></i>
                <h1 class="username">User</h1>
            </span>
            <i class="fa-solid fa-arrow-right-from-bracket" onclick="exitfromapp()"></i>
        </div>
        <div>
            <h1>Games</h1>
            <div>
                <div onclick="tictac()">
                    <img src="./images/tictactoe.png"/>
                    <h1>TicTacToe</h1>
                </div>
                <div onclick="footballgame()">
                    <img src="./images/football.jfif"/>
                    <h1>FootBall Over</h1>
                </div>
            </div>
        </div>
    </div>
     <div class="tictactoegame">
        <h1>TicTacToe</h1>
        <div class="gametable" id="gametable">
            <!-- Cells will be created by JS -->
        </div>
        <div class="ticback">
            <button class="reset-btn" onclick="resetGame()">Reset</button>
            <button class="menu-btn" onclick="tictomenu()">Menu</button>
        </div>
        <div class="winner-overlay" id="winnerOverlay">
            <div id="winnerText"></div>
            <button onclick="resetGame()">Play Again</button>
        </div>
    </div>
    <div class="settings">
        <button onclick="settingstomenu()"><-Back</button>
        <span class="changenickblock">
            <label>Name:</label>
            <input type="text" class="changeusername"/>
            <button onclick="changeusername()" class="changebtn">Submit</button>
        </span>
    </div>
    <div class="changeduser" id="changeduser">
        <h2>Your username has changed successfully</h2>
        <button onclick="closeChangedUser()">Ok</button>
    </div>

    <div class="football-over" style="display:none;">
        <h1>Football Over</h1>
        <p class="choose-text">Kimni <span id="positionText">hujum</span>ga qo'yasan?</p>

        <div class="players" id="playersContainer">
            <!-- JS orqali o'yinchilar qo'shiladi -->
        </div>

        <div class="foot-controls">
            <button onclick="nextPosition()">Keyingi</button>
            <button onclick="backToMenu()">Menu</button>
        </div>

        <div class="selected-team" id="selectedTeam">
            <h2>Tanlangan jamoa</h2>
            <ul></ul>
            <h1 class="overtext">Umumiy Over: </h1>
            <button onclick="restartFootball()" class="reset-btn">Qayta boshlash</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        
        tg.expand();
        tg.ready();

        const userinput = document.querySelector(".userinput");
        const username = document.querySelector(".username");
        const askingusername = document.querySelector(".askusername");
        const mainmenu = document.querySelector(".mainmenu");
        const tictacgame = document.querySelector(".tictactoegame");
        const gametable = document.getElementById("gametable");
        const winnerOverlay = document.getElementById("winnerOverlay");
        const winnerText = document.getElementById("winnerText");
        const setingsblock = document.querySelector('.settings')
        const userchange = document.querySelector('.changeusername')
        const footballgameblock = document.querySelector('.football-over')



        function nonetoblock(discard, add) {
            discard.style.display = 'none';
            add.style.display = 'block';
        }

        function nameentry() {
            if(userinput.value) {
                username.innerHTML = userinput.value;
            } else {
                username.innerHTML = 'User';
            }
            nonetoblock(askingusername, mainmenu);
        }


        function tictac() {
            nonetoblock(mainmenu, tictacgame);
            initGame();
        }

        function tictomenu() {
            nonetoblock(tictacgame, mainmenu);
        }

        let board = [];
        let currentPlayer = "X";
        let gameOver = false;

        function initGame() {
            gametable.innerHTML = '';
            board = ["", "", "", "", "", "", "", "", ""];
            gameOver = false;
            winnerOverlay.style.display = 'none';
            currentPlayer = "X";

            for(let i=0; i<9; i++){
                const cell = document.createElement("div");
                cell.classList.add("cell");
                cell.dataset.index = i;
                cell.addEventListener("click", () => makeMove(i));
                gametable.appendChild(cell);
            }
        }

        function makeMove(index) {
            if(board[index] !== "" || gameOver || currentPlayer !== "X") return;

            board[index] = "X";
            const cellEl = document.querySelector(`.cell[data-index='${index}']`);
            cellEl.innerText = "X";
            cellEl.style.color = "blue"; // X ko'k rang

            if(checkWinner()) {
                showWinner(`${username.innerHTML} wins!`);
                gameOver = true;
                return;
            }

            if(board.every(cell => cell !== "")) {
                showWinner("Draw!");
                gameOver = true;
                return;
            }

            currentPlayer = "O";
            setTimeout(botMove, 500);
        }

        function botMove() {
            if(gameOver) return;

            let emptyIndexes = board.map((val, idx) => val === "" ? idx : null).filter(val => val !== null);
            let botIndex = emptyIndexes[Math.floor(Math.random() * emptyIndexes.length)];

            board[botIndex] = "O";
            const cellEl = document.querySelector(`.cell[data-index='${botIndex}']`);
            cellEl.innerText = "O";
            cellEl.style.color = "red"; // O qizil rang

            if(checkWinner()) {
                showWinner("Bot wins!");
                gameOver = true;
                return;
            }

            if(board.every(cell => cell !== "")) {
                showWinner("Draw!");
                gameOver = true;
                return;
            }

            currentPlayer = "X";
        }

        function checkWinner() {
            const winCombos = [
                [0,1,2], [3,4,5], [6,7,8],
                [0,3,6], [1,4,7], [2,5,8],
                [0,4,8], [2,4,6]
            ];
            return winCombos.some(combo => 
                board[combo[0]] !== "" &&
                board[combo[0]] === board[combo[1]] &&
                board[combo[1]] === board[combo[2]]
            );
        }

        function showWinner(message) {
            winnerText.innerText = message;
            winnerOverlay.style.display = 'flex';
        }

        function resetGame() {
            initGame();
        }

        function settingsopen() {
            nonetoblock(mainmenu, setingsblock)
            userchange.value = username.innerHTML
        }

        function changeusername() {
            username.innerHTML = userchange.value 
        }

        function settingstomenu() {
            nonetoblock(setingsblock, mainmenu)
        }

        function changeusername() {
            const newName = document.querySelector(".changeusername").value;
            if(newName) {
                document.querySelector(".username").innerText = newName;
                document.getElementById("changeduser").style.display = "block";
            }
        }

        function closeChangedUser() {
            document.getElementById("changeduser").style.display = "none";
            document.querySelector(".changeusername").value = "";
        }

        function footballgame() {
            nonetoblock(mainmenu, footballgameblock)
        }

        const positions = ["hujum", "yarim himoya", "himoya", "darvoza"];
        let currentPosition = 0;
        let team = [];

        let overs = {
            "Cristiano Ronaldo": 97,
            "Lionel Messi": 97,
            "Neymar Jr": 96,
            "Kylian Mbappé": 98,
            "Kevin De Bruyne": 95,
            "Virgil van Dijk": 93,
            "Sergio Ramos": 96,
            "Thibaut Courtois": 95,
            "Manuel Neuer": 94
        };

        const playersData = [
            {name: "Cristiano Ronaldo", img: "./images/ronaldo.jpg"},
            {name: "Lionel Messi", img: "./images/messi.jpg"},
            {name: "Neymar Jr", img: "./images/neymar.jfif"},
            {name: "Kylian Mbappé", img: "./images/mbappe.jfif"},
            {name: "Kevin De Bruyne", img: "./images/debruyne.jfif"},
            {name: "Virgil van Dijk", img: "./images/vandijk.jpg"},
            {name: "Sergio Ramos", img: "./images/ramos.jpg"},
            {name: "Thibaut Courtois", img: "./images/courtois.jfif"},
            {name: "Manuel Neuer", img: "./images/neuer.jfif"}
        ];

        // Har bir pozitsiya uchun futbolchilarni ajratamiz
        const positionPlayers = {
            "hujum": ["Cristiano Ronaldo", "Neymar Jr", "Kylian Mbappé"],
            "yarim himoya": ["Lionel Messi", "Kevin De Bruyne"],
            "himoya": ["Virgil van Dijk", "Sergio Ramos"],
            "darvoza": ["Thibaut Courtois", "Manuel Neuer"]
        };

        function footballgame() {
            nonetoblock(mainmenu, footballgameblock);
            currentPosition = 0;
            team = [];
            document.getElementById("selectedTeam").style.display = "none";
            renderPlayers();
        }

        function renderPlayers() {
            const container = document.getElementById("playersContainer");
            container.innerHTML = "";
            document.getElementById("positionText").innerText = positions[currentPosition];

            // faqat shu pozitsiyaga mos futbolchilarni chiqaramiz
            let allowedPlayers = positionPlayers[positions[currentPosition]];

            playersData.forEach(p => {
                if(allowedPlayers.includes(p.name)) {
                    const div = document.createElement("div");
                    div.classList.add("player-card");
                    div.innerHTML = `<img src="${p.img}" alt="${p.name}">
                                    <h3>${p.name}</h3>
                                    <p>OVR: ${overs[p.name]}</p>`;
                    div.onclick = () => selectPlayer(p);
                    container.appendChild(div);
                }
            });
        }

        function selectPlayer(player) {
            team.push({pos: positions[currentPosition], name: player.name, ovr: overs[player.name]});
            nextPosition();
        }

        function nextPosition() {
            if(currentPosition < positions.length - 1) {
                currentPosition++;
                renderPlayers();
            } else {
                showTeam();
            }
        }

        function showTeam() {
            document.getElementById("playersContainer").innerHTML = "";
            document.querySelector(".choose-text").innerText = "Jamoangiz tayyor!";
            const teamList = document.querySelector("#selectedTeam ul");
            teamList.innerHTML = "";

            // tanlangan jamoani chiqarish
            team.forEach(p => {
                let li = document.createElement("li");
                li.innerText = `${p.pos.toUpperCase()}: ${p.name} (OVR: ${overs[p.name]})`;
                teamList.appendChild(li);
            });

            // umumiy over hisoblash
            let total = team.reduce((sum, p) => sum + overs[p.name], 0);
            let umumiyOver = Math.round(total / team.length);

            // umumiy overni chiqarish
            let overDiv = document.createElement("div");
            overDiv.classList.add("Umumiy-Over");
            document.querySelector('.overtext').innerHTML = `Umumiy Over: <b>${umumiyOver}</b>`;
            teamList.parentElement.appendChild(overDiv);

            document.getElementById("selectedTeam").style.display = "block";
        }


        function restartFootball() {
            currentPosition = 0;
            team = [];
            document.getElementById("selectedTeam").style.display = "none";
            document.querySelector(".choose-text").innerHTML = 
            `Kimni <span id="positionText">${positions[currentPosition]}</span>ga qo'yasan?`;
            renderPlayers();
        }

        function backToMenu() {
            nonetoblock(footballgameblock, mainmenu);
        }

        function exitfromapp() {
            tg.close();
        }

    </script>
</body>

</html>
